{"title":"透過Cloud IAP遠端連線至Linux VM","uid":"1a65d31cdb3e52c51c1542789d236996","slug":"gcp-iap","date":"2022-03-21T02:45:22.000Z","updated":"2022-03-21T07:38:26.224Z","comments":true,"path":"api/articles/gcp-iap.json","keywords":"Flutter, Dart, MSIX, webview_windows, Javascript, Web, VBA, Excel","cover":"https://mrtang.tw/wp-content/uploads/2017/09/1505355061-24b1fd8e4fa17ca39961de99073f397a.png","content":"<p>講述Cloud IAP前，先來說一下Cloud IAM，Cloud IAM的全名為<strong>Identity and Access Management</strong>，顧名思義就是身份與權限管理服務，管理員可以透過設定IAM，來指派使用者的身份，並授權使用者存取GCP內的資源。</p>\n<p>而Cloud IAP(Identity-Aware Proxy)中的TCP-Forwarding則是透過HTTPS的加密安全連線和IAM的權限管理來建立快速的安全連線，讓我們能夠在不使用外部IP的情況下，也能輕鬆又安全的連接上我們的Compute Engine。</p>\n<p><img src=\"https://storage.googleapis.com/cloudace-tw-blog/1/2021/11/IAP_TCP_Forwarding-blog-images-12.png\"></p>\n<p><em>取自<a href=\"https://blog.cloud-ace.tw/identity-security/iap-tcp-forwarding/\">Cloud Ace</a></em></p>\n<p>如圖所示，透過IAP TCP-Forwarding，只需將VM的port通道打開，就可以直接透過通道連接至VM。</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\">Linux</th>\n<th align=\"center\">Windows</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">連接方式</td>\n<td align=\"center\">SSH</td>\n<td align=\"center\">RDP(遠端桌面連線)</td>\n</tr>\n<tr>\n<td align=\"center\">預設port</td>\n<td align=\"center\">22</td>\n<td align=\"center\">3389</td>\n</tr>\n</tbody></table>\n<p>今天就來紀錄一下如何使用Cloud IAP建立Linux VM連線，並使用GCP Web SSH來連線至VM</p>\n<h2 id=\"設置防火墻\"><a href=\"#設置防火墻\" class=\"headerlink\" title=\"設置防火墻\"></a>設置防火墻</h2><p>首先先新增一個用於Cloud IAP連線的防火牆規則<br>打開<strong>虛擬私有網路(VPC network)</strong> &gt; <strong>防火牆(Firewall)</strong> &gt; <strong>建立防火牆規則(Create VPC Network)</strong><br><img src=\"https://i.imgur.com/PXb3ESC.png\" alt=\"Imgur\"></p>\n<p>接著填入以下配置並建立:</p>\n<ul>\n<li>名稱：<code>allow-from-iap</code></li>\n<li>流量方向：輸入</li>\n<li>目標：網路中所有執行個體</li>\n<li>來源篩選器：IPv4範圍</li>\n<li>來源IPv4範圍：<code>35.235.240.0/20</code></li>\n<li>協議及端口：<code>TCP</code>:<code>22</code>(允許SSH)<br><img src=\"https://i.imgur.com/pcyMbVE.png\" alt=\"Imgur\"></li>\n</ul>\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">提示</p>\n<p>防火牆預設會有<code>default-allow-ssh</code>及<code>default-allow-rdp</code>這兩個規則，這兩個規則會允許所有主機連線至VM，建議可以停用或刪除</p>\n</div>\n<h2 id=\"設置IAM權限\"><a href=\"#設置IAM權限\" class=\"headerlink\" title=\"設置IAM權限\"></a>設置IAM權限</h2><p>開啟 <strong>IAM與管理</strong> &gt; <strong>身分與存取權管理</strong> &gt; <strong>新增</strong></p>\n<ul>\n<li>新增主體：需要連線的email</li>\n<li>角色(Role)：<ul>\n<li>Compute執行個體管理員 / Compute Instance Admin（v1）</li>\n<li>受IAP保護的通道使用者 / IAP-secured Tunnel User<br>新增以下條件:<ul>\n<li>名稱： <code>limit port</code></li>\n<li>條件編輯器：<code>destination.port == 22</code></li>\n</ul>\n</li>\n<li>Service Management管理員 / Service Management Administrator</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://i.imgur.com/k4kzShW.png\" alt=\"Imgur\"></p>\n<p>接著開啟<strong>IAM與管理</strong> &gt; <strong>服務帳戶</strong> &gt; 勾選<strong>Compute Engine default service account</strong> &gt; <strong>管理存取權</strong> &gt; <strong>新增主體</strong><br><img src=\"https://i.imgur.com/pPz7FdB.png\" alt=\"Imgur\"></p>\n<ul>\n<li>主體：需要連線的email</li>\n<li>角色：編輯者</li>\n</ul>\n<h2 id=\"啟用IAP\"><a href=\"#啟用IAP\" class=\"headerlink\" title=\"啟用IAP\"></a>啟用IAP</h2><p>進入<strong>安全性</strong> &gt; <strong>Identity-Aware Proxy</strong> &gt; <strong>SSH和TCP資源</strong>，若未啟用API請先啟用，啟用完成則會看到以下畫面<br><img src=\"https://i.imgur.com/VY0a846.png\" alt=\"Imgur\"></p>\n<h2 id=\"GCP-Web-SSH登入測試\"><a href=\"#GCP-Web-SSH登入測試\" class=\"headerlink\" title=\"GCP Web SSH登入測試\"></a>GCP Web SSH登入測試</h2><p>最後登入主體帳戶，進入Compute Engine點擊SSH連線<br><img src=\"https://i.imgur.com/F4KSBtE.png\" alt=\"Imgur\"></p>\n<p>若看到以下畫面就大功告成啦～<br><img src=\"https://i.imgur.com/MMqBE0p.png\" alt=\"Imgur\"></p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://blog.cloud-ace.tw/identity-security/iap-tcp-forwarding/\">比 VPN 連線、跳板機更方便！利用 Cloud IAP 快速建立遠端安全連線 - Cloud Ace 技術部落客</a></li>\n<li><a href=\"https://blog.cloud-ace.tw/identity-security/what-is-cloud-iam/\">什麼是 Cloud IAM - Cloud Ace 技術部落客</a></li>\n<li><a href=\"https://cloud.google.com/iap/docs/using-tcp-forwarding\">Using IAP for TCP forwarding | Identity-Aware Proxy | Google Cloud</a></li>\n</ul>\n","feature":true,"text":"講述Cloud IAP前，先來說一下Cloud IAM，Cloud IAM的全名為Identity and Access Management，顧名思義就是身份與權限管理服務，管理員可以透過設定IAM，來指派使用者的身份，並授權使用者存取GCP內的資源。 而Cloud IAP(I...","link":"","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"GCP","slug":"GCP","count":1,"path":"api/categories/GCP.json"}],"tags":[{"name":"Linux","slug":"Linux","count":4,"path":"api/tags/Linux.json"},{"name":"GCP","slug":"GCP","count":4,"path":"api/tags/GCP.json"},{"name":"IAM","slug":"IAM","count":1,"path":"api/tags/IAM.json"},{"name":"IAP","slug":"IAP","count":1,"path":"api/tags/IAP.json"},{"name":"Compute Engine","slug":"Compute-Engine","count":1,"path":"api/tags/Compute-Engine.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%A8%AD%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%BB\"><span class=\"toc-text\">設置防火墻</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%A8%AD%E7%BD%AEIAM%E6%AC%8A%E9%99%90\"><span class=\"toc-text\">設置IAM權限</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%95%9F%E7%94%A8IAP\"><span class=\"toc-text\">啟用IAP</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#GCP-Web-SSH%E7%99%BB%E5%85%A5%E6%B8%AC%E8%A9%A6\"><span class=\"toc-text\">GCP Web SSH登入測試</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\"><span class=\"toc-text\">參考資料</span></a></li></ol>","author":{"name":"Shirley","slug":"shirley","avatar":"https://i.imgur.com/lM0jHtF.png","link":"/","description":"記錄雜七雜八的秘密基地","socials":{"github":"https://github.com/cailirl980519","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"book":{"icon":"fa fa-envelope","link":"mailto://cailirl980519@gmail.com"}}}},"mapped":true,"prev_post":{},"next_post":{"title":"Debian環境下Nginx使用SSL憑證","uid":"51f769b5c3aa532276c680c9cd35b4aa","slug":"linux-ssl","date":"2022-03-10T02:51:55.000Z","updated":"2022-03-21T07:37:00.404Z","comments":true,"path":"api/articles/linux-ssl.json","keywords":"Flutter, Dart, MSIX, webview_windows, Javascript, Web, VBA, Excel","cover":"https://whc.ca/wp-content/uploads/blog_15418_large.jpg","text":"為了在GCP打造安全的虛擬機環境，打算將所有的資料傳輸改為HTTPS安全傳輸協定，確保使用者能夠擁有安全連線，今天就來紀錄一下如何在GCP內的Debian環境使用Let’s Encrypt簽發有效期為90天的SSL憑證，並能夠在快到期時自動更新憑證，省得每次都忘記更新憑證導致使用...","link":"","photos":[],"count_time":{"symbolsCount":"4.7k","symbolsTime":"4 mins."},"categories":[{"name":"Linux","slug":"Linux","count":3,"path":"api/categories/Linux.json"}],"tags":[{"name":"Linux","slug":"Linux","count":4,"path":"api/tags/Linux.json"},{"name":"Debian","slug":"Debian","count":3,"path":"api/tags/Debian.json"},{"name":"GCP","slug":"GCP","count":4,"path":"api/tags/GCP.json"},{"name":"Nginx","slug":"Nginx","count":2,"path":"api/tags/Nginx.json"},{"name":"SSL","slug":"SSL","count":1,"path":"api/tags/SSL.json"},{"name":"Let's Encrypt","slug":"Let-s-Encrypt","count":1,"path":"api/tags/Let-s-Encrypt.json"}],"author":{"name":"Shirley","slug":"shirley","avatar":"https://i.imgur.com/lM0jHtF.png","link":"/","description":"記錄雜七雜八的秘密基地","socials":{"github":"https://github.com/cailirl980519","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"book":{"icon":"fa fa-envelope","link":"mailto://cailirl980519@gmail.com"}}}},"feature":true}}